

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/bg/icon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="William Tao">
  <meta name="keywords" content="websafe">
  
    <meta name="description" content="文件上传漏洞（uploadlibs）文件上传原理在文件上传的功能处，若服务端脚本语言未对上传的文件进行严格验证和过滤，导致恶意用户上传恶意的脚本文件时，就有可能获取执行服务端命令的能力，这就是文件上传漏洞。 必要条件1.存在上传点2.可以上传动态文件3.上传目录有执行权限4.可访问到上传的动态文件 检测 代码分析前端1234567891011&lt;html&gt;     &lt;body&amp;gt">
<meta property="og:type" content="article">
<meta property="og:title" content="文件上传漏洞（uploadlibs）">
<meta property="og:url" content="http://example.com/2022/05/03/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%EF%BC%88uploadlibs%EF%BC%89/index.html">
<meta property="og:site_name" content="taoke-one 博客">
<meta property="og:description" content="文件上传漏洞（uploadlibs）文件上传原理在文件上传的功能处，若服务端脚本语言未对上传的文件进行严格验证和过滤，导致恶意用户上传恶意的脚本文件时，就有可能获取执行服务端命令的能力，这就是文件上传漏洞。 必要条件1.存在上传点2.可以上传动态文件3.上传目录有执行权限4.可访问到上传的动态文件 检测 代码分析前端1234567891011&lt;html&gt;     &lt;body&amp;gt">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-16515608406902.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-16515608458244.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-16515608498476.png">
<meta property="og:image" content="http://example.com/20210402100128125.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-16515608576079.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156085993411.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156086199813.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156086436615.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156086695817.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156086986219.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156087298321.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156087581623.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156087851825.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156088135627.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156090262229.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156092322231.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156092870433.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156093181435.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156093468637.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156093652639.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156093953641.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156094126243.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156094286245.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156094490447.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156094730249.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156094919851.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156095085553.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156095247355.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156095486457.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156095717559.png">
<meta property="og:image" content="http://example.com/20210412173132489.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210412173714543.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156096173862.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156096413464.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156096743066.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156097037668.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156097251070.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156097544672.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156097771274.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156098015876.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156098425478.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156098884680.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156099092282.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156099301584.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156099735886.png">
<meta property="og:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156100039888.png">
<meta property="article:published_time" content="2022-05-03T07:09:22.000Z">
<meta property="article:modified_time" content="2022-05-08T03:43:54.053Z">
<meta property="article:author" content="William Tao">
<meta property="article:tag" content="websafe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70.png">
  
  
  <title>文件上传漏洞（uploadlibs） - taoke-one 博客</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>导航</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="文件上传漏洞（uploadlibs）">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-05-03 15:09" pubdate>
        2022年5月3日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      11k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      91 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">文件上传漏洞（uploadlibs）</h1>
            
            <div class="markdown-body">
              <h1 id="文件上传漏洞（uploadlibs）"><a href="#文件上传漏洞（uploadlibs）" class="headerlink" title="文件上传漏洞（uploadlibs）"></a>文件上传漏洞（uploadlibs）</h1><h1 id="文件上传原理"><a href="#文件上传原理" class="headerlink" title="文件上传原理"></a>文件上传原理</h1><p>在文件上传的功能处，若服务端脚本语言未对上传的文件进行严格验证和过滤，导致恶意用户上传恶意的脚本文件时，就有可能获取执行服务端命令的能力，这就是文件上传漏洞。</p>
<h2 id="必要条件"><a href="#必要条件" class="headerlink" title="必要条件"></a>必要条件</h2><p>1.存在上传点<br>2.可以上传动态文件<br>3.上传目录有执行权限<br>4.可访问到上传的动态文件</p>
<h2 id="检测"><a href="#检测" class="headerlink" title="检测"></a>检测</h2><p><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h1 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h1><h2 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h2><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;upload_file.php&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span></span><br><span class="hljs-tag">     <span class="hljs-attr">enctype</span>=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">&quot;file&quot;</span>&gt;</span>Filename:<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;file&quot;</span> /&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Submit&quot;</span> /&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>“upload_file.php”规定了处理上传数据的后台php脚本文件。</li>
<li>“method” 规定上传的方法为post方法。</li>
<li>“enctype”规定了上传数据的编码方式。在表单需要二进制数据时，比如文件内容，请使用 “multipart&#x2F;form-data”。</li>
<li>“multipart&#x2F;form-data”表示不进行编码，文件上传的表单一般采用这种。</li>
<li>标签的 type&#x3D;“file” 属性规定了应该把输入作为文件来处理。</li>
</ul>
<h2 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;error&quot;</span>] &gt; <span class="hljs-number">0</span>)<br>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;错误：&quot;</span> . <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;error&quot;</span>] . <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;上传文件名: &quot;</span> . <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;name&quot;</span>] . <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;文件类型: &quot;</span> . <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>] . <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;文件大小: &quot;</span> . (<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;size&quot;</span>] / <span class="hljs-number">1024</span>) . <span class="hljs-string">&quot; kB&lt;br&gt;&quot;</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;文件临时存储的位置: &quot;</span> . <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;tmp_name&quot;</span>];<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>服务器拿到上传的文件数据之后，会先将其存为一个临时文件，由$_FILES这个全局变量调取使用。</p>
<ul>
<li>$_FILES[“file”][“name”] - 上传文件的名称</li>
<li>$_FILES[“file”][“type”] - 上传文件的类型</li>
<li>$_FILES[“file”][“size”] - 上传文件的大小，以字节计</li>
<li>$_FILES[“file”][“tmp_name”] - 存储在服务器的文件的临时副本的名称</li>
<li>$_FILES[“file”][“error”] - 由文件上传导致的错误代码</li>
</ul>
<h1 id="uploads-libs练习"><a href="#uploads-libs练习" class="headerlink" title="uploads-libs练习"></a>uploads-libs练习</h1><p><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-16515608406902.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-16515608458244.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h3 id="pass1（前端检测）"><a href="#pass1（前端检测）" class="headerlink" title="pass1（前端检测）"></a>pass1（前端检测）</h3><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-keyword">function</span> <span class="hljs-title function_">checkFile</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> file = document.getElementsByName(<span class="hljs-string">&#x27;upload_file&#x27;</span>)[<span class="hljs-number">0</span>].value;<br>    <span class="hljs-keyword">if</span> (file == <span class="hljs-literal">null</span> || file == <span class="hljs-string">&quot;&quot;</span>) &#123;<br>        alert(<span class="hljs-string">&quot;请选择要上传的文件!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-comment">//定义允许上传的文件类型</span><br>    <span class="hljs-keyword">var</span> allow_ext = <span class="hljs-string">&quot;.jpg|.png|.gif&quot;</span>;<br>    <span class="hljs-comment">//提取上传文件的类型</span><br>    <span class="hljs-keyword">var</span> ext_name = file.substring(file.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br>    <span class="hljs-comment">//判断上传文件类型是否允许上传</span><br>    <span class="hljs-keyword">if</span> (allow_ext.<span class="hljs-built_in">indexOf</span>(ext_name + <span class="hljs-string">&quot;|&quot;</span>) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-keyword">var</span> errMsg = <span class="hljs-string">&quot;该文件不允许上传，请上传&quot;</span> + allow_ext + <span class="hljs-string">&quot;类型的文件,当前文件类型为：&quot;</span> + ext_name;<br>        alert(errMsg);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>分析一波代码：</p>
<ul>
<li>getElementsByName() 方法可返回带有指定名称的对象的集合。</li>
<li>substring(start,stop):用于提取字符串中介于两个指定下标之间的字符。<br>如果省略stop参数，那么返回的子串会一直到字符串的结尾。</li>
<li>lastIndexOf( ) ：返回指定的字符串值最后出现的位置，如果指定第二个参数 start，则在一个字符串中的指定位置从后向前搜索。没有找到返回-1。</li>
<li>indexOf() ：返回指定的字符串值在字符串中首次出现的位置。如果没有找到匹配的字符串则返回 -1。</li>
<li>file_exists() ：检查文件或目录是否存在<br>语法：file_exists ( string $filename )<br>$filename：文件或目录的路径</li>
</ul>
<p>绕过方法有两种：<br>1.在查看器里面删除oncheck函数<br>2.用bp截包，修改文件filename&#x3D;xxx.php<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-16515608498476.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h3 id="pass2（MIME-content-type检测）"><a href="#pass2（MIME-content-type检测）" class="headerlink" title="pass2（MIME content type检测）"></a>pass2（MIME content type检测）</h3><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs lisp">if (($_FILES[&#x27;upload_file&#x27;][&#x27;type&#x27;] == &#x27;image/jpeg&#x27;) ||<br> ($_FILES[&#x27;upload_file&#x27;][&#x27;type&#x27;] == &#x27;image/png&#x27;) ||<br>  ($_FILES[&#x27;upload_file&#x27;][&#x27;type&#x27;] == &#x27;image/gif&#x27;))<br></code></pre></td></tr></table></figure>

<p>在服务器端对数据包的MIME进行检查，只让Content-Type为image&#x2F;jpeg | image&#x2F;png | image&#x2F;gif 的文件通过。由下可知，它只对Content-Type做了判断，并没有对文件进行判断。因此我们可以上传 .php文件，但是Content-Type改为image&#x2F;png。</p>
<p>绕过方法：<br>方法一：与第一关一样，直接修改后缀名 。<br>方法二：修改Content-Type，使其满足要求即可。</p>
<h3 id="pass3（黑名单检测）"><a href="#pass3（黑名单检测）" class="headerlink" title="pass3（黑名单检测）"></a>pass3（黑名单检测）</h3><p><img src="/20210402100128125.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-variable">$is_upload</span> = false;<br><span class="hljs-variable">$msg</span> = null;<br><span class="hljs-keyword">if</span> (isset(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;<br>        <span class="hljs-variable">$deny_ext</span> = array(<span class="hljs-string">&#x27;.asp&#x27;</span>,<span class="hljs-string">&#x27;.aspx&#x27;</span>,<span class="hljs-string">&#x27;.php&#x27;</span>,<span class="hljs-string">&#x27;.jsp&#x27;</span>);<br>        <span class="hljs-variable">$file_name</span> = trim(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);<br>        <span class="hljs-variable">$file_name</span> = deldot(<span class="hljs-variable">$file_name</span>);<span class="hljs-regexp">//</span>删除文件名末尾的点<br>        <span class="hljs-variable">$file_ext</span> = strrchr(<span class="hljs-variable">$file_name</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<br>        <span class="hljs-variable">$file_ext</span> = strtolower(<span class="hljs-variable">$file_ext</span>); <span class="hljs-regexp">//</span>转换为小写<br>        <span class="hljs-variable">$file_ext</span> = str_ireplace(<span class="hljs-string">&#x27;::$DATA&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$file_ext</span>);<span class="hljs-regexp">//</span>去除字符串::<span class="hljs-variable">$DATA</span><br>        <span class="hljs-variable">$file_ext</span> = trim(<span class="hljs-variable">$file_ext</span>); <span class="hljs-regexp">//</span>收尾去空<br><br>        <span class="hljs-keyword">if</span>(!in_array(<span class="hljs-variable">$file_ext</span>, <span class="hljs-variable">$deny_ext</span>)) &#123;<br>            <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>            <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.date(<span class="hljs-string">&quot;YmdHis&quot;</span>).rand(<span class="hljs-number">1000</span>,<span class="hljs-number">9999</span>).<span class="hljs-variable">$file_ext</span>;            <br>            <span class="hljs-keyword">if</span> (move_uploaded_file(<span class="hljs-variable">$temp_file</span>,<span class="hljs-variable">$img_path</span>)) &#123;<br>                 <span class="hljs-variable">$is_upload</span> = true;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;不允许上传.asp,.aspx,.php,.jsp后缀文件！&#x27;</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$msg</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码分析：</p>
<ul>
<li>trim() 函数：移除字符串两侧的空白字符或其他预定义字符。<br>trim(string,charlist)<br>string 必需。规定要检查的字符串。<br>charlist<br>可选。规定从字符串中删除哪些字符。如果被省略，则移除以下所有字符： “\0” - NULL； “\t” - 制表符；”\n” - 换行； “\x0B” - 垂直制表符；”\r” - 回车； “ “ - 空格</li>
<li>deldot(file_name); 删除文件名末尾的点</li>
<li>strrchr ()： 查找指定字符在字符串中的最后一次出现<br>语法：strrchr ( string,char )<br>string：被查找的字符串<br>char：出现的部分字符串<br>该函数返回char在 string 字符串中的最后一次出现的位置后面string一部分</li>
<li>strtolower() 函数：把字符串转换为小写。</li>
<li>str_ireplace() 函数替换字符串中的一些字符（不区分大小写）。<br>str_ireplace(find,replace,string)</li>
<li>利用Windows特性<br>在window的时候如果文件名+”::$DATA”会把::$DATA之后的数据当成文件流处理,不会检测后缀名，且保持::$DATA之前的文件名，他的目的就是不检查后缀名<br>例如:“phpinfo.php::$DATA”Windows会自动去掉末尾的::$DATA变成”phpinfo.php”</li>
<li>in_array() 函数:搜索数组中是否存在指定的值.<br>in_array(search,array,type)<br>search 必需。规定要在数组搜索的值。<br>array 必需。规定要搜索的数组。<br>type 可选。如果设置该参数为 true，则检查搜索的数据与数组的值的类型是否相同。type 参数设置为 true，则搜索区分大小写。<br>返回值： 如果在数组中找到值则返回 TRUE，否则返回 FALSE。</li>
</ul>
<h2 id="绕过方法（黑名单）"><a href="#绕过方法（黑名单）" class="headerlink" title="绕过方法（黑名单）"></a>绕过方法（黑名单）</h2><h4 id="1-修改后缀名"><a href="#1-修改后缀名" class="headerlink" title="1.修改后缀名"></a>1.修改后缀名</h4><p>将文件后缀改为phtml,php3,php4,php5,pht，直接上传。</p>
<h4 id="2-上传图片-bp"><a href="#2-上传图片-bp" class="headerlink" title="2.上传图片+bp"></a>2.上传图片+bp</h4><p>上传图片马，bp拦截将filename改为phtml,php3,php4,php5,pht</p>
<h4 id="3-方法三：-htaccess文件"><a href="#3-方法三：-htaccess文件" class="headerlink" title="3.方法三：.htaccess文件"></a>3.方法三：.htaccess文件</h4><p>利用“ .htaccess ”超文本入口（Hypertext Access）</p>
<p>概述来说，htaccess文件是Apache服务器中的一个配置文件，它负责相关目录下的网页配置。通过htaccess文件，可以帮我们实现：网页301重定向、自定义404错误页面、改变文件扩展名、允许&#x2F;阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。</p>
<p>先上传 .htaccess文件，内容为SetHandler<br>application&#x2F;x-httpd-php。利用Bp拦截。如图，将文件的名字去掉，只留下后缀.htaccess<br>然后再上传图片马。(无需将图片马的后缀改为php)</p>
<h2 id="pass4（htaccess文件和点空格点）"><a href="#pass4（htaccess文件和点空格点）" class="headerlink" title="pass4（htaccess文件和点空格点）"></a>pass4（htaccess文件和点空格点）</h2><p><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-16515608576079.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156085993411.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h5 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h5><p>方法一：htaccess文件<br>后缀修改为：点+空+点</p>
<h2 id="pass5（点空格点绕过）"><a href="#pass5（点空格点绕过）" class="headerlink" title="pass5（点空格点绕过）"></a>pass5（点空格点绕过）</h2><p><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156086199813.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>代码中有<br>1.删除文件名的不合法字符（空格）；<br>2.有删除末尾的点；<br>3.然后用strrchr截取最后一个点和它后面的字符串<br>4.然后转化为小写<br>5.删去 “::$DATA”</p>
<p><strong>可以用php+点+空格+点绕过</strong><br>先删去空格，再删去一个点，最后strrchr截取到最后一个点，下面匹配不成功，成功绕过检测</p>
<h2 id="psaa6（大小写绕过）"><a href="#psaa6（大小写绕过）" class="headerlink" title="psaa6（大小写绕过）"></a>psaa6（大小写绕过）</h2><p><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156086436615.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>代码没有了转化为小写的代码，以可以用大小写来绕过检测<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156086695817.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h2 id="pass7（加空格绕过）"><a href="#pass7（加空格绕过）" class="headerlink" title="pass7（加空格绕过）"></a>pass7（加空格绕过）</h2><p><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156086986219.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>代码里没有了删去空格的代码，<br>所以可以给.php后面加上空格绕过检测<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156087298321.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h2 id="pass8（加点绕过）"><a href="#pass8（加点绕过）" class="headerlink" title="pass8（加点绕过）"></a>pass8（加点绕过）</h2><p><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156087581623.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p>代码里没有了删去点的这行代码，利用windows特性，会自动去掉后缀名中最后的”.”，可在后缀名中加”.”绕过<br><strong>所以可以加点或绕过</strong><br>因为 strrchr函数返回指定字符（点），和他后面的字符，带入下面的if<br>判断成立<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156087851825.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h2 id="pass9"><a href="#pass9" class="headerlink" title="pass9"></a>pass9</h2><p><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156088135627.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<ul>
<li>文件没有对后缀名进行去”::DATA”处理 。<br>php在window的时候如果（文件名+”::DATA”）<br>会把::DATA的数据当成文件流处理 ,不会检测后缀名。且保持 ::DATA”之前的文件名 他的目的就是不检查后缀名。<br>不会检测后缀名.”ps:只能是Windows系统，并且只能时php文件</li>
</ul>
<p>在网页上检查图片马的执行情况时，将图片马的后缀名中 ::$DATA ，删去，便可浏览。</p>
<p><strong>如图，这个是没有去掉后缀时，会发生报错。（因为我们实际上传的是PHP文件，即upload文件夹中只有php文件，而不存在带有后缀 ::$DATA的文件）</strong><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156090262229.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156092322231.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p>修改.jpg后缀为.php::$DATA<br>如图<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156092870433.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p>看到upload文件下生成一个php文件<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156093181435.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>菜刀连接<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156093468637.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h1 id="pass10（点-空格-点）"><a href="#pass10（点-空格-点）" class="headerlink" title="pass10（点+空格+点）"></a>pass10（点+空格+点）</h1><p><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156093652639.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述">代码的意思是<br>1.先trim() 函数：移除字符串两侧的空白字符或其他预定义字符。<br>这个函数的意思是<strong>移除字符串两端的空白字符。</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$str</span> = <span class="hljs-string">&quot;  muma.php. .  &quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;不使用 trim: &quot;</span> . <span class="hljs-variable">$str</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;使用 trim: &quot;</span> . <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$str</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>输出：<br>不使用 trim: （有空格） muma.php. .（有空格）<br>使用 trim: muma.php. …<br>2.删除末尾的点<br>3.在从最后一个点的位置开始，截取最后一个点到末尾的字符串<br>3.转换为小写<br>5.把::$DATA,用空格代替<br>6.首位 去空。<br>把文件名改为：muma.php.空格.按顺序执行代码：<br>1.muma.php.空格.<br>2.muma.php.空格<br>3.点+空格<br>4.点+空格<br>5.点<br>与下面的in_array(file_ext, deny_ext)匹配不正确，成功绕过</p>
<h1 id="pass11（双写后缀名）"><a href="#pass11（双写后缀名）" class="headerlink" title="pass11（双写后缀名）"></a>pass11（双写后缀名）</h1><p><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156093953641.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述">看代码，这里用str_ireplace函数把文件名内的预定义的字符串换位空格，这是想到双写绕过（和sql注入一样的道理）<br>pphphp–&gt;去除中间的php–&gt;还剩一个php<br>成功绕过！</p>
<p><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156094126243.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h1 id="pass12（URL上00截断）"><a href="#pass12（URL上00截断）" class="headerlink" title="pass12（URL上00截断）"></a>pass12（URL上00截断）</h1><p><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156094286245.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>strrpos() 函数：查找字符串在另一字符串中最后一次出现的位置。对大小写敏感</p>
<p>img_path &#x3D; GET[‘save_path’].”&#x2F;“.rand(10, 99).date(“YmdHis”).”.”.file_ext;</p>
<p>函数将文件与后缀名直接进行拼接<br>我们发现ima-path直接拼接 而且还是GET方式<br>因此可以%00绕过</p>
<p>php版本小于5.3.4<br>php的magic_quotes_gpc为OFF状态<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156094490447.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h1 id="pass13（POST请求，二进制文件中00截断）"><a href="#pass13（POST请求，二进制文件中00截断）" class="headerlink" title="pass13（POST请求，二进制文件中00截断）"></a>pass13（POST请求，二进制文件中00截断）</h1><p>php版本小于5.3.4php版本小于5.3.4<br>php的magic_quotes_gpc为OFF状态<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156094730249.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述">代码与12不同的是，<strong>路径用post获取</strong><br>post不会像get对%00进行自动解码。</p>
<p>由源码可知，直接将 file_ext 拼接在路径中，因此我们可以在中间时将php加在 $file_ext 中，从而以PHP文件解析。再由 $_POST[‘save_path’]请求可知， 参数save_path 虽然不会出现在URl中，但是我们可以在包里面发现他，因此我们可以在包里面对 $file_ext 中进行更改。但是POST是以二进制流进行发送文件，因此我们需要在封包的 <strong>二进制文件</strong> 中对 $file_ext添加php和对应的 <strong>00截断</strong> 。</p>
<p><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156094919851.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>在上面的upload 的后面加上 XXX.php++<br>这里的xxx.php随便起名，最后会继承后面截断的内容<br>将二进制中的 + 改为 00 截断，即将 + 的二进制码 2b 改为 00<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156095085553.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述">绕过<br>因为程序中检测的是文件的后缀名，如果后缀合法则拼接路径和文件名。那么，攻击者修改了path以后的拼接结为：uploads&#x2F;aaa.php%00&#x2F;20190818.php。移动文件的时候会将文件保存为：uploads&#x2F;aaa.php<br>从而达到Getshell效果。</p>
<h1 id="pass14（简单头文件-x2F-图片马-文件包含）"><a href="#pass14（简单头文件-x2F-图片马-文件包含）" class="headerlink" title="pass14（简单头文件&#x2F;图片马+文件包含）"></a>pass14（简单头文件&#x2F;图片马+文件包含）</h1><p>图片马必须配合文件包含才能使用<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156095247355.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述">这里对上传文件的内容进行了检测，因此要对文件内容修改<br>它对文件的头两个字节进行了判断，因此我们可以直接上传图片马</p>
<h2 id="一、利用GIF98a"><a href="#一、利用GIF98a" class="headerlink" title="一、利用GIF98a"></a>一、利用GIF98a</h2><p>因为源代码只是对上传内容的前两个字节进行检测，<strong>所以可以通过在上传的文件前追加合法的文件头进行绕过</strong><br>一句话木马改为<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156095486457.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述">这里的GIF98a：<br>文件头标识 (6 bytes)47 49 46 38 39(37) 61，<br>字符即 GIF89(7)a</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs erlang">文件头标识：<br>（<span class="hljs-number">1</span>）JPEG<br>- 文件头标识 <span class="hljs-params">(<span class="hljs-number">2</span> bytes)</span>: 0xff, 0xd8 <span class="hljs-params">(SOI)</span> <span class="hljs-params">(JPEG 文件标识)</span><br>- 文件结束标识 <span class="hljs-params">(<span class="hljs-number">2</span> bytes)</span>: 0xff, 0xd9 <span class="hljs-params">(EOI)</span><br>（2）PNG<br>-文件头标识 <span class="hljs-params">(<span class="hljs-number">8</span> bytes)</span>   89 50 4E 47 0D 0A 1A 0A<br>（4）GIF<br> 文件头标识 <span class="hljs-params">(<span class="hljs-number">6</span> bytes)</span> 47 49 46 38 39<span class="hljs-params">(<span class="hljs-number">37</span>)</span> 61,字符即:GIF89 <span class="hljs-params">(<span class="hljs-number">7</span>)</span>a<br></code></pre></td></tr></table></figure>

<p>成功上传!在结合文件包含漏洞，用菜刀连接即可！<br>这里利用文件包含执行了PHP语句。<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156095717559.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h2 id="二、利用图片马"><a href="#二、利用图片马" class="headerlink" title="二、利用图片马"></a>二、利用图片马</h2><p><strong>制作图片马：</strong><br>copy命令：copy 1.jpg&#x2F;b+muma.php&#x2F;a tupianmuma.jpg<br><img src="/20210412173132489.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述">这里的1.jpg为正常图片，muma.php为一句话木马<br>进行上传！通过检测验证。接下来就是菜刀连接<br>直接复制图片地址，用菜刀连接是不行的。因为php脚本并不被解析<br>这里需要用到<strong>文件包含漏洞</strong></p>
<p><strong>1.本身的文件包含</strong><br><img src="https://img-blog.csdnimg.cn/20210412173714543.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>它的内容是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">本页面存在文件包含漏洞，用于测试图片马是否能正常运行！</span><br><span class="hljs-comment">*/</span><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Content-Type:text/html;charset=utf-8&quot;</span>);<br><span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$file</span>))&#123;<br>    <span class="hljs-keyword">include</span> <span class="hljs-variable">$file</span>;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-title function_ invoke__">show_source</span>(__file__);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>进入文件包含页面：<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156096173862.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述">因为它存在文件包含漏洞，进行查看图片<br>输入file&#x3D;图片的地址（这里要的是upload&#x2F;…）<br>页面用php解析<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156096413464.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述">这时候复制地址，菜刀连接<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156096743066.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述">结论：图片木马必须配合文件包含漏洞才能使用</p>
<p><strong>2.构造文件包含漏洞</strong><br>也可以写一个简单的文件包含<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156097037668.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h1 id="pass15（getimagesize函数检测）-图片马绕过"><a href="#pass15（getimagesize函数检测）-图片马绕过" class="headerlink" title="pass15（getimagesize函数检测）+图片马绕过"></a>pass15（getimagesize函数检测）+图片马绕过</h1><p><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156097251070.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p><strong>getimagesize()函数：</strong><br>用于获取图像大小及相关信息，成功返回一个数组，失败则返回 FALSE 并产生一条 E_WARNING 级的错误信息。</p>
<p>getimagesize() 函数将测定任何 GIF，JPG，PNG，SWF，SWC，PSD，TIFF，BMP，IFF，JP2，JPX，JB2，JPC，XBM 或 WBMP 图像文件的大小并返回图像的尺寸以及文件类型及图片高度与宽度。</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs abnf">返回结果说明<br><br>索引 <span class="hljs-number">0</span> 给出的是图像宽度的像素值<br>索引 <span class="hljs-number">1</span> 给出的是图像高度的像素值<br>索引 <span class="hljs-number">2</span> 给出的是图像的类型，返回的是数字，其中<span class="hljs-number">1</span> <span class="hljs-operator">=</span> GIF，<br><span class="hljs-number">2</span> <span class="hljs-operator">=</span> JPG，<span class="hljs-number">3</span> <span class="hljs-operator">=</span> PNG，<span class="hljs-number">4</span> <span class="hljs-operator">=</span> SWF，<span class="hljs-number">5</span> <span class="hljs-operator">=</span> PSD，<span class="hljs-number">6</span> <span class="hljs-operator">=</span> BMP，<br><span class="hljs-number">7</span> <span class="hljs-operator">=</span> TIFF(intel byte order)，<span class="hljs-number">8</span> <span class="hljs-operator">=</span> TIFF(motorola byte order)，<br><span class="hljs-number">9</span> <span class="hljs-operator">=</span> JPC，<span class="hljs-number">10</span> <span class="hljs-operator">=</span> JP2，<span class="hljs-number">11</span> <span class="hljs-operator">=</span> JPX，<span class="hljs-number">12</span> <span class="hljs-operator">=</span> JB2，<span class="hljs-number">13</span> <span class="hljs-operator">=</span> 	SWC，<br><span class="hljs-number">14</span> <span class="hljs-operator">=</span> IFF，<span class="hljs-number">15</span> <span class="hljs-operator">=</span> WBMP，<span class="hljs-number">16</span> <span class="hljs-operator">=</span> XBM<br>索引 <span class="hljs-number">3</span> 给出的是一个宽度和高度的字符串，可以直接用于<br> HTML 的 &lt;image&gt; 标签<br>索引 bits 给出的是图像的每种颜色的位数，二进制格式<br>索引 channels 给出的是图像的通道值，RGB 图像默认是 <span class="hljs-number">3</span><br>索引 mime 给出的是图像的 MIME 信息，此信息可以用来在<br> HTTP Content-type 头信息中发送正确的信息，<br> 如： header(<span class="hljs-string">&quot;Content-type: image/jpeg&quot;</span>)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p><strong>image_type_to_extension函数</strong><br>— 根据指定的图像类型返回对应的后缀名<br><strong>stripos() 函数</strong><br>查找字符串在另一字符串中第一次出现的位置（不区分大小写）。<br>这里可以利用图片马进行绕过，与pass14一样</p>
<h1 id="pass16（exif-imagetype函数检测）-图片马绕过"><a href="#pass16（exif-imagetype函数检测）-图片马绕过" class="headerlink" title="pass16（exif_imagetype函数检测）+图片马绕过"></a>pass16（exif_imagetype函数检测）+图片马绕过</h1><p><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156097544672.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><strong>exif_imagetype()</strong><br>读取一个图像的第一个字节并检查其签名。<br>要打开php_exif扩展才能正常上传<br>GIF98a和图片马绕过</p>
<h1 id="pass17（二次渲染）"><a href="#pass17（二次渲染）" class="headerlink" title="pass17（二次渲染）"></a>pass17（二次渲染）</h1><p>$_FILES[‘myFile’][‘name’] 客户端文件的原名称。<br>$_FILES[‘myFile’][‘type’] 文件的 MIME 类型，需要浏览器提供该信息的支持，例如”image&#x2F;gif”。<br>$_FILES[‘myFile’][‘size’] 已上传文件的大小，单位为字节。<br>$_FILES[‘myFile’][‘tmp_name’] 文件被上传后在服务端储存的临时文件名，一般是系统默认。可以在php.ini的<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156097771274.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>代码分析：<br><strong>imagecreatefromjpeg （filename）</strong><br>— 由文件或 URL 创建一个新图象<br>成功后返回图象资源,失败后返回 false。<br>返回一图像标识符，代表了从给定的文件名取得的图像。<br><strong>move_uploaded_file(old,new)</strong> —<br>将上传的文件移动到新位置<br><strong>strval() 函数</strong><br>用于获取变量的字符串值。</p>
<p>上传的图片会进行二次渲染，所以正常的图片马会被重新渲染，渲染之后的图片马中的webshell被渲染掉，没有了原来了PHP语句<br>这是应该观察上传前后的图片进行对比，观察经过渲染的图片和图片马的前后没有变化的地方,我们只需要找到渲染前后没有变化的位置,然后将php代码写进去,就可以成功上传带有php代码的图片了.</p>
<p>对比可以用bp的对比器模块，也可用16进制的编辑器（我用的010）</p>
<p>下面进行上传：<br>1.先上传正常的图片马，然后把渲染后的图片下载到本地，用010进行对比，找到渲染前后没有变化的部分。<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156098015876.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述">2.然后在下载的图片中找到渲染前后没有变化的部分插入php语句或webshell，<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156098425478.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>3.用修改后的图片（真正有webshell的图片）再次上传，发现PHP语句没有被洗掉，成功绕过二次渲染。<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156098884680.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>最后，进行二次渲染的时候最好用gif文件.因为gif文件在渲染前后有大部分的没有变化，容易找到前后没有变化的部分。png的二次渲染的绕过并不能像gif那样简单.<br>具体绕过还没学会</p>
<h1 id="pass18（竞争条件）-（多线程发包）"><a href="#pass18（竞争条件）-（多线程发包）" class="headerlink" title="pass18（竞争条件）+（多线程发包）"></a>pass18（竞争条件）+（多线程发包）</h1><p><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156099092282.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>查看源码：<br><strong>rename() 函数</strong><br>重命名文件或目录。<br>如果成功，该函数返回 TRUE。如果失败，则返回 FALSE。<br>rename(oldname,newname)<br>尝试把 oldname 重命名为 newname</p>
<p>绕过思路：<br>当我们上传web shell文件时，不会先限制php类型文件上传，先利用上面的语句把上传的文件临时存放。再执行下面的if语句进行文件类型的限制和文件名的时间戳。然后执行if(move_uploaded_file($temp_file, $upload_file))&#x2F;&#x2F;移动到新文件夹</p>
<p>绕过思路是利用代码执行过程有耗费时间的过程。临时webshell文件保存的极短时间，去访问webshell。获取一些信息我们可以利用burp多线程发包，然后不断在浏览器访问我们的webshell。会有一瞬间的访问成功</p>
<p>系统执行过程为：当 jpg 图片上传时, 后台先生成图片的临时文件名$ tem_file路径，并且他也会拼接生成一个新的文件名 $ upoad_load路径，然后将临时文件名 $ tem_file的路径放到新的文件名$ upoad_load的路径下面。之后对图片进行后缀检验 ，如果为白名单 jpg、png、gif的格式，那么将生成一个新的文件名 $ img_path路径, 并用新的路径名对之前的$ upoad_load的路径名 进行重命名覆盖。</p>
<p>发包用bp拦截<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156099301584.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>修改线程数：<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156099735886.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述">开始攻击！.<br>然后在upload文件夹里看到会有上传的webshell一闪一闪，在浏览器进行访问，快速刷新，会有一刻访问到上传的文件的<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU4NTEzMw==,size_16,color_FFFFFF,t_70-165156100039888.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h1 id="IIS-5-x-x2F-6-0解析漏洞"><a href="#IIS-5-x-x2F-6-0解析漏洞" class="headerlink" title="IIS 5.x&#x2F;6.0解析漏洞"></a>IIS 5.x&#x2F;6.0解析漏洞</h1><p><strong>（1）目录解析漏洞</strong><br>在网站中建立名字为*.asp、*.asa的文件夹，其目录内的任何扩展名文件都会被IIS当做ASP文件来解析并执行。</p>
<p><strong>（2）文件解析漏洞</strong><br>网站上传图片的时候，如果将网页木马文件的名字改成”<em>.asp;1.jpg”，分号后面的不被解析，也就是说，”</em>.asp;1.jpg”会被服务器看成是*.asp，就可以绕过服务器禁止上传ASP文件的限制，这样的畸形文件也同样会被IIS当做ASP文件来解析并执行。</p>
<p>例如：上传一个图片文件名为”test.asp;1.jpg”的木马文件，该文件可以被当做ASP文件解析并执行。</p>
<h1 id="apache解析漏洞"><a href="#apache解析漏洞" class="headerlink" title="apache解析漏洞"></a>apache解析漏洞</h1><p>其2.4.0-2.4.29中存在apache换行解析漏洞，就是我们平常所说的从右向左解析是一样的。当apache遇到无法识别解析的文件后缀时，会向前解析，如xxx.php.123.456,在mime.types文件中如果不存在.123&#x2F;.456这两种后缀，那么apache会将该文件解析为php。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/05/08/xray%E8%81%94%E5%8A%A8burpsuite%E4%B8%8Eawvs/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">xray联动burpsuite与awvs</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/04/10/SQLi-lab%E6%B5%8B%E8%AF%95/">
                        <span class="hidden-mobile">SQLi_lab测试</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
